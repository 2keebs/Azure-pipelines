variables:
- name: BuildParameters.solution
  value: '**\*.sln'
- name: BuildConfiguration
  value: Release
- name: BuildPlatform
  value: 'Any CPU'

resources:
  repositories:
  - repository: Farmer 
    type: github
    endpoint: rkovaci92
    name: mdsecactivebreach/Farmer
  - repository: Rubeus
    type: github
    endpoint: rkovaci92
    name: GhostPack/Rubeus
  - repository: Seatbelt 
    type: github
    endpoint: rkovaci92
    name: GhostPack/Seatbelt
  - repository: SafetyKatz 
    type: github
    endpoint: rkovaci92
    name: GhostPack/SafetyKatz
  - repository: SharpUp
    type: github
    endpoint: rkovaci92
    name: GhostPack/SharpUp
  - repository: SharpDPAPI 
    type: github
    endpoint: rkovaci92
    name: GhostPack/SharpDPAPI
  - repository: Certify 
    type: github
    endpoint: rkovaci92
    name: GhostPack/Certify
  - repository: KrbRelayUp
    type: github
    endpoint: rkovaci92
    name: Dec0ne/KrbRelayUp
  - repository: Snaffler 
    type: github
    endpoint: rkovaci92
    name: SnaffCon/Snaffler
  - repository: SharpSQL 
    type: github
    endpoint: rkovaci92
    name: mlcsec/SharpSQL
  - repository: SharpWebServer
    type: github
    endpoint: rkovaci92
    name: mgeeky/SharpWebServer
  - repository: SharpWMI 
    type: github
    endpoint: rkovaci92
    name: GhostPack/SharpWMI
  - repository: SharpMiniDump
    type: github
    endpoint: rkovaci92
    name: b4rtik/SharpMiniDump
  - repository: Internal-Monologue 
    type: github
    endpoint: rkovaci92
    name: eladshamir/Internal-Monologue
  - repository: Whisker 
    type: github
    endpoint: rkovaci92
    name: eladshamir/Whisker
  - repository: StandIn
    type: github
    endpoint: rkovaci92
    name: FuzzySecurity/StandIn
  - repository: SharpView 
    type: github
    endpoint: rkovaci92
    name: tevora-threat/SharpView
  - repository: SharpHound 
    type: github
    endpoint: rkovaci92
    name: BloodHoundAD/SharpHound3

trigger:
- main

pool:
  vmImage: 'windows-2019'

steps:
- checkout: Farmer
- checkout: Rubeus
- checkout: Seatbelt
- checkout: SafetyKatz
- checkout: SharpUp
- checkout: SharpDPAPI
- checkout: Certify
- checkout: KrbRelayUp
- checkout: Snaffler
- checkout: SharpSQL
- checkout: SharpWebServer
- checkout: SharpWMI
- checkout: SharpMiniDump
- checkout: Internal-Monologue
- checkout: Whisker
- checkout: StandIn
- checkout: SharpView
- checkout: SharpHound

- task: NuGetToolInstaller@0
  displayName: Use NuGet 4.4.1
  inputs:
    versionSpec: 4.4.1
- task: NuGetCommand@2
  displayName: NuGet restore
  inputs:
    solution: $(BuildParameters.solution)
  
- task: PowerShell@2
  displayName: PowerShell Script for StandIn
  inputs:
    targetType: inline
    script: "Set-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml '<?xml version=\"1.0\" encoding=\"utf-8\" ?>'\nAdd-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml '<Weavers>'\nAdd-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml '<Costura>'\nAdd-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml 'DisableCleanup=\"true\"'\nAdd-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml '<IncludeAssemblies>'\nAdd-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml 'CommandLine'\nAdd-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml '</IncludeAssemblies>'\nAdd-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml '</Costura>'\nAdd-Content D:\\a\\1\\s\\StandIn\\StandIn\\FodyWeavers.xml '</Weavers>'"
  
- task: PowerShell@2
  displayName: PowerShell Script for SharpView
  inputs:
    targetType: inline
    script: "Set-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml '<?xml version=\"1.0\" encoding=\"utf-8\" ?>'\nAdd-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml '<Weavers>'\nAdd-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml '<Costura>'\nAdd-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml 'DisableCleanup=\"true\"'\nAdd-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml '<IncludeAssemblies>'\nAdd-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml 'CommandLine'\nAdd-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml '</IncludeAssemblies>'\nAdd-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml '</Costura>'\nAdd-Content D:\\a\\1\\s\\SharpView\\FodyWeavers.xml '</Weavers>'"

- task: PowerShell@2
  displayName: PowerShell Script for SharpHound
  inputs:
    targetType: inline
    script: "Set-Content D:\\a\\1\\s\\FodyWeavers.xml '<?xml version=\"1.0\" encoding=\"utf-8\" ?>'\nAdd-Content D:\\a\\1\\s\\FodyWeavers.xml '<Weavers>'\nAdd-Content D:\\a\\1\\s\\FodyWeavers.xml '<Costura>'\nAdd-Content D:\\a\\1\\s\\FodyWeavers.xml 'DisableCleanup=\"true\"'\nAdd-Content D:\\a\\1\\s\\FodyWeavers.xml '<IncludeAssemblies>'\nAdd-Content D:\\a\\1\\s\\FodyWeavers.xml 'CommandLine'\nAdd-Content D:\\a\\1\\s\\FodyWeavers.xml '</IncludeAssemblies>'\nAdd-Content D:\\a\\1\\s\\FodyWeavers.xml '</Costura>'\nAdd-Content D:\\a\\1\\s\\FodyWeavers.xml '</Weavers>'"
  
- task: VSBuild@1
  displayName: Build solution **\*.sln
  inputs:
    solution: $(BuildParameters.solution)
    platform: $(BuildPlatform)
    configuration: $(BuildConfiguration)
- task: VSTest@2
  displayName: VsTest - testAssemblies
  inputs:
    testAssemblyVer2: >-
      **\$(BuildConfiguration)\*test*.dll
       !**\obj\**
    platform: $(BuildPlatform)
    configuration: $(BuildConfiguration)
- task: PublishSymbols@2
  displayName: Publish symbols path
  continueOnError: True
  inputs:
    SearchPattern: '**\bin\**\*.pdb'
    PublishSymbols: false
    SymbolServerType: TeamServices
- task: CopyFiles@2
  displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
  condition: succeededOrFailed()
  inputs:
    SourceFolder: $(system.defaultworkingdirectory)
    Contents: '**\bin\$(BuildConfiguration)\**'
    TargetFolder: $(build.artifactstagingdirectory)

- task: CopyFiles@2
  displayName: 'Copy Dependencies to: $(build.artifactstagingdirectory)'
  condition: succeededOrFailed()
  inputs:
    SourceFolder: $(system.defaultworkingdirectory)\StandIn\StandIn\packages\
    Contents: '**'
    TargetFolder: $(build.artifactstagingdirectory)\StandIn\StandIn\StandIn\bin\Release\

- task: CopyFiles@2
  displayName: 'Copy Dependencies to: $(build.artifactstagingdirectory)'
  condition: succeededOrFailed()
  inputs:
    SourceFolder: $(system.defaultworkingdirectory)\SharpView\
    Contents: '**'
    TargetFolder: $(build.artifactstagingdirectory)\SharpView\SharpView\bin\Release\
- task: CopyFiles@2
  displayName: 'Copy Dependencies to: $(build.artifactstagingdirectory)'
  condition: succeededOrFailed()
  inputs:
    SourceFolder: $(system.defaultworkingdirectory)\SharpHound\
    Contents: '**'
    TargetFolder: $(build.artifactstagingdirectory)\SharpHound\bin\Release\
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  condition: succeededOrFailed()
  inputs:
    PathtoPublish: $(build.artifactstagingdirectory)
    TargetPath: '\\my\share\$(Build.DefinitionName)\$(Build.BuildNumber)'